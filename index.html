<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n PY</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#27ae60">
    <link rel="apple-touch-icon" href="./logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 480px; min-height: 100vh; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        .auth-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        input, select, textarea { padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; box-sizing: border-box; }
        
        .scanner-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; height: 260px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 0 45px rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
        .guide-rect { width: 85%; height: 150px; border: 3px solid var(--primary); border-radius: 12px; }

        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        #resultados { margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; text-align: left; border: 2px solid #3498db; display: none; }
        .label-res { font-size: 12px; color: #34495e; font-weight: bold; margin-bottom: 5px; margin-top: 15px; display: block; text-transform: uppercase; }
        
        .checkbox-group { max-height: 180px; overflow-y: auto; border: 1px solid #bdc3c7; padding: 12px; border-radius: 10px; background: #fcfcfc; }
        .checkbox-item { display: block; margin-bottom: 10px; font-size: 14px; }
        
        .radio-group { display: flex; gap: 20px; padding: 10px 0; }
        #offlineAlert { display: none; background: #e74c3c; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        
        .event-container { display: flex; gap: 8px; align-items: center; }
        .event-container select { flex: 1; }
        .btn-mini { padding: 15px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <div id="offlineAlert">‚ö†Ô∏è Sin conexi√≥n. Los datos se sincronizar√°n al volver el internet.</div>

        <div id="loginSection">
            <h2>Ingreso al Sistema</h2>
            <form class="auth-form" id="loginForm">
                <input type="email" id="email" placeholder="Correo electr√≥nico" required>
                <input type="password" id="password" placeholder="Contrase√±a" required>
                <button type="submit" class="btn">INGRESAR</button>
            </form>
        </div>

        <div id="scannerSection" style="display: none;">
            <div id="cameraView">
                <div class="scanner-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="overlay"><div class="guide-rect"></div></div>
                </div>
                <button class="btn" onclick="capturarCedula()">üì∑ CAPTURAR DATOS DEL CLIENTE</button>
            </div>

            <div id="loading" style="display:none; padding: 20px; font-weight: bold; color: var(--primary);">‚åõ PROCESANDO...</div>

            <div id="resultados">
                <label class="label-res">NOMBRE Y APELLIDO *:</label>
                <input type="text" id="resNombre">
                
                <label class="label-res">N√öMERO DE C√âDULA *:</label>
                <input type="number" id="resCedula">

                <label class="label-res">N√öMERO DE CELULAR *:</label>
                <input type="tel" id="resCelular" placeholder="Ej: 0981 123 456">

                <hr style="border: 0.5px solid #eee; margin: 20px 0;">

                <label class="label-res">NOMBRE DEL EVENTO *:</label>
                <div class="event-container">
                    <select id="resEvento"></select>
                    <button class="btn-mini" style="background: #3498db;" onclick="agregarEvento()">‚ûï</button>
                    <button class="btn-mini" style="background: #e74c3c;" onclick="eliminarEvento()">üóëÔ∏è</button>
                </div>

                <label class="label-res">CORREO ELECTR√ìNICO (CLIENTE):</label>
                <input type="email" id="resCorreoCliente" placeholder="ejemplo@correo.com">

                <label class="label-res">¬øACTIV√ì UN PRODUCTO NUEVO? *</label>
                <div class="radio-group">
                    <label><input type="radio" name="resProducto" value="SI"> SI</label>
                    <label><input type="radio" name="resProducto" value="No" checked> No</label>
                </div>

                <label class="label-res">MOTIVO DE ATENCI√ìN *:</label>
                <div class="checkbox-group" id="contenedorMotivos"></div>

                <label class="label-res">C√ìDIGO DE TARJETA (CAJA):</label>
                <input type="text" id="resCodigoTarjeta">

                <label class="label-res">COMENTARIO ADICIONAL:</label>
                <textarea id="resComentario" rows="3"></textarea>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" style="flex: 2;" onclick="confirmarGuardado()">‚úÖ GUARDAR REGISTRO</button>
                    <button class="btn" style="flex: 1; background: #e74c3c;" onclick="resetEscaneo()">üîÑ</button>
                </div>
            </div>

            <button onclick="exportarExcel()" style="background:#34495e; color:white; border:none; padding:12px; margin-top:40px; border-radius:8px; width:100%;">üìä DESCARGAR EXCEL</button>
            <p id="userEmailDisplay" style="font-size: 12px; font-weight: bold; margin-top: 15px;"></p>
            <button onclick="auth.signOut(); location.reload();" style="background:none; border:none; color:red; text-decoration:underline; cursor:pointer;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log("PWA lista"));
        }

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAE1KBu1CufjKO65OpVHOPcmhyliQYsoDU",
            authDomain: "miescanerweb.firebaseapp.com",
            projectId: "miescanerweb",
            storageBucket: "miescanerweb.firebasestorage.app",
            messagingSenderId: "403272649163",
            appId: "1:403272649163:web:53f29dd4e676c31d268e4e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence();

        // üü¢ TU ENLACE DE GOOGLE SHEETS YA CONFIGURADO:
        const URL_GOOGLE_SHEETS = 'https://script.google.com/a/macros/ueno.com.py/s/AKfycbyp50uQF0KAQPWCBh_lwxDwlBEVPd9DXZLkQu5_2NrY15yfQc7Hjg4JljQTNoEkKzSBsA/exec';

        const MOTIVOS = [
            "-Consultas", "-Onboarding sin retiro", "-Onboarding con retiro", "-Solo vinculaci√≥n",
            "-Activaci√≥n TC/TD", "-Firma CU", "-TC Albirroja nueva", "-Error vinculaci√≥n",
            "-Inconveniente Registro", "-Oferta TC denegada", "-Oferta Pr√©stamo", "-Cuenta menor",
            "-Reimpresi√≥n tarjeta", "-Reimpresi√≥n Albirroja", "-Ahorro programado", "-Reclamos",
            "-Solicitud TC", "-Aumento l√≠nea", "-Error app", "-Vinculaci√≥n Alias",
            "-F√© de vida", "-Cambio entidad jubilados", "-Nuevo Jubilado", "-Otro"
        ];

        // LOGICA DE INTERFAZ
        function cargarOpciones() {
            const evSel = document.getElementById('resEvento');
            const evs = JSON.parse(localStorage.getItem('listaEventosPY')) || ["IPS", "Playa San Jose", "Rakiura"];
            evSel.innerHTML = '<option value="">Seleccionar...</option>';
            evs.forEach(e => evSel.innerHTML += `<option value="${e}">${e}</option>`);

            const motCont = document.getElementById('contenedorMotivos');
            motCont.innerHTML = "";
            MOTIVOS.forEach(m => {
                motCont.innerHTML += `<label class="checkbox-item"><input type="checkbox" name="motivoItem" value="${m}"> ${m}</label>`;
            });
        }

        function agregarEvento() {
            let n = prompt("Nuevo evento:");
            if(n) {
                let evs = JSON.parse(localStorage.getItem('listaEventosPY')) || ["IPS", "Playa San Jose", "Rakiura"];
                evs.push(n);
                localStorage.setItem('listaEventosPY', JSON.stringify(evs));
                cargarOpciones();
            }
        }

        function eliminarEvento() {
            let s = document.getElementById('resEvento');
            if(!s.value) return;
            let evs = JSON.parse(localStorage.getItem('listaEventosPY')).filter(e => e !== s.value);
            localStorage.setItem('listaEventosPY', JSON.stringify(evs));
            cargarOpciones();
        }

        // AUTH
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('scannerSection').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = "üë§ Operador: " + user.email;
                encenderCamara();
                cargarOpciones();
            }
        });

        document.getElementById('loginForm').onsubmit = e => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value);
        };

        // C√ÅMARA E IA
        async function encenderCamara() {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video').srcObject = s;
        }

        async function capturarCedula() {
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);
            const res = await Tesseract.recognize(c.toDataURL(), 'spa');
            document.getElementById('resCedula').value = res.data.text.replace(/\D/g, '').substring(0,8);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultados').style.display = 'block';
        }

        function resetEscaneo() {
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('cameraView').style.display = 'block';
        }

        // GUARDADO (FIREBASE + GOOGLE SHEETS)
        async function confirmarGuardado() {
            const nom = document.getElementById('resNombre').value;
            const ced = document.getElementById('resCedula').value;
            if(!nom || !ced) return alert("Nombre y C√©dula obligatorios");

            const motivos = Array.from(document.querySelectorAll('input[name="motivoItem"]:checked')).map(cb => cb.value).join(' | ');
            
            const payload = {
                fecha: new Date().toLocaleString(),
                operador: auth.currentUser.email,
                evento: document.getElementById('resEvento').value,
                nombre: nom,
                cedula: ced,
                celular: document.getElementById('resCelular').value,
                correo: document.getElementById('resCorreoCliente').value,
                producto: document.querySelector('input[name="resProducto"]:checked').value,
                motivos: motivos,
                codigo: document.getElementById('resCodigoTarjeta').value,
                comentario: document.getElementById('resComentario').value
            };

            // 1. Guardar en Firebase (Offline Ready)
            await db.collection("escaneos").add(payload);

            // 2. Enviar a Google Sheets (Si hay internet)
            if(navigator.onLine && URL_GOOGLE_SHEETS.includes('exec')) {
                fetch(URL_GOOGLE_SHEETS, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
            }

            alert("‚úÖ Registro guardado con √©xito.");
            resetEscaneo();
        }

        // EXCEL LOCAL
        async function exportarExcel() {
            const snap = await db.collection("escaneos").get();
            const filas = [];
            snap.forEach(doc => filas.push(doc.data()));
            const ws = XLSX.utils.json_to_sheet(filas);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");
            XLSX.writeFile(wb, "Reporte_Eventos.xlsx");
        }
    </script>
</body>
</html>

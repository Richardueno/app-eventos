<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n PY</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#27ae60">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 480px; min-height: 100vh; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        .logo { max-width: 180px; height: auto; margin: 10px auto 20px auto; display: block; }

        .auth-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="tel"], select, textarea { 
            padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; box-sizing: border-box; 
        }
        
        .password-container { position: relative; width: 100%; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; user-select: none; }

        .scanner-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; height: 260px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 0 45px rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
        .guide-rect { width: 85%; height: 150px; border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 0 15px var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-link { background: none; border: none; color: #3498db; cursor: pointer; font-size: 15px; text-decoration: underline; margin-top: 10px; }
        
        #resultados { margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; text-align: left; border: 2px solid #3498db; display: none; }
        .label-res { font-size: 12px; color: #34495e; font-weight: bold; margin-bottom: 5px; margin-top: 15px; display: block; text-transform: uppercase; }
        .editable-input { margin-bottom: 5px; background-color: #fcfcfc; border: 1px solid #bdc3c7; color: var(--dark); }

        .checkbox-group { max-height: 250px; overflow-y: auto; border: 1px solid #bdc3c7; padding: 12px; border-radius: 10px; background: #fcfcfc; margin-bottom: 5px; }
        .checkbox-item { display: block; margin-bottom: 10px; font-size: 14px; color: #2c3e50; }
        .checkbox-item input { margin-right: 8px; transform: scale(1.2); }

        .radio-group { display: flex; gap: 20px; padding: 10px 0; font-size: 16px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        .auth-check { background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 20px; display: flex; align-items: flex-start; gap: 10px; text-align: left; font-size: 13px; color: #856404; }
        .name-grid { display: flex; gap: 10px; }
        #offlineAlert { display: none; background: #e74c3c; color: white; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; font-size: 13px; }
        .event-container { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; }
        .btn-mini { padding: 15px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="offlineAlert">‚ö†Ô∏è Sin conexi√≥n a Internet. Los datos se guardar√°n localmente.</div>

        <img src="logo.png?v=2" alt="Logo de la App" class="logo" id="logoApp" onerror="this.style.display='none'">

        <div id="loginSection">
            <h2>Ingreso al Sistema</h2>
            <form class="auth-form" id="loginForm">
                <input type="email" id="email" name="email" placeholder="Correo electr√≥nico" autocomplete="username" required>
                <div class="password-container">
                    <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('password', 'ojoLogin')"><span id="ojoLogin">üëÅÔ∏è</span></span>
                </div>
                <button type="submit" class="btn">INGRESAR</button>
            </form>
            <button class="btn-link" onclick="cambiarPantalla('registerSection')">¬øNo tienes cuenta? Reg√≠strate aqu√≠</button>
        </div>

        <div id="registerSection" style="display: none;">
            <h2>Crear Cuenta</h2>
            <form class="auth-form" id="registerForm">
                <div class="name-grid">
                    <input type="text" id="regNombre" name="fname" placeholder="Nombre" autocomplete="given-name" required>
                    <input type="text" id="regApellido" name="lname" placeholder="Apellido" autocomplete="family-name" required>
                </div>
                <input type="email" id="regEmail" name="email" placeholder="Correo electr√≥nico" autocomplete="username" required>
                <div class="password-container">
                    <input type="password" id="regPassword" name="new-password" placeholder="Contrase√±a (m√≠n. 6 letras)" autocomplete="new-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('regPassword', 'ojoReg1')"><span id="ojoReg1">üëÅÔ∏è</span></span>
                </div>
                <div class="password-container">
                    <input type="password" id="regConfirmPassword" name="confirm-password" placeholder="Confirme su contrase√±a" autocomplete="new-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('regConfirmPassword', 'ojoReg2')"><span id="ojoReg2">üëÅÔ∏è</span></span>
                </div>
                <button type="submit" class="btn" style="background: #3498db;">REGISTRARME</button>
            </form>
            <button class="btn-link" style="color: #27ae60;" onclick="cambiarPantalla('loginSection')">¬øYa tienes cuenta? Inicia sesi√≥n</button>
        </div>

        <div id="scannerSection" style="display: none;">
            <h3 id="welcomeMsg" style="color: var(--dark); margin-top: 0; margin-bottom: 20px;"></h3>

            <div id="cameraView">
                <div class="scanner-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="overlay"><div class="guide-rect"></div></div>
                </div>
                <button class="btn" onclick="capturarCedula()">üì∑ CAPTURAR DATOS DEL CLIENTE</button>
            </div>

            <div id="loading" style="display:none; margin: 20px; font-weight: bold; color: var(--primary);">‚åõ PROCESANDO...</div>

            <div id="resultados">
                <label class="label-res">NOMBRE Y APELLIDO *:</label>
                <input type="text" id="resNombre" class="editable-input" style="font-weight: bold;">
                <label class="label-res">N√öMERO DE C√âDULA *:</label>
                <input type="number" id="resCedula" class="editable-input" style="font-weight: bold;">
                <label class="label-res">N√öMERO DE CELULAR *:</label>
                <input type="tel" id="resCelular" class="editable-input">

                <hr style="border: 0.5px solid #eee; margin: 20px 0;">

                <label class="label-res">NOMBRE DEL EVENTO *:</label>
                <div class="event-container">
                    <select id="resEvento" class="editable-input"></select>
                    <button type="button" class="btn-mini" style="background: #3498db;" onclick="agregarEvento()">‚ûï</button>
                    <button type="button" class="btn-mini" style="background: #e74c3c;" onclick="eliminarEvento()">üóëÔ∏è</button>
                </div>

                <label class="label-res">CORREO ELECTR√ìNICO:</label>
                <input type="email" id="resCorreoCliente" class="editable-input">

                <label class="label-res">¬øPRODUCTO NUEVO? *</label>
                <div class="radio-group">
                    <label><input type="radio" name="resProducto" value="SI"> SI</label>
                    <label><input type="radio" name="resProducto" value="No" checked> No</label>
                </div>

                <label class="label-res">MOTIVO DE ATENCI√ìN *:</label>
                <div class="checkbox-group" id="contenedorMotivos"></div>

                <label class="label-res">C√ìD. TARJETA (CAJA):</label>
                <input type="text" id="resCodigoTarjeta" class="editable-input">

                <label class="label-res">COMENTARIO ADICIONAL:</label>
                <textarea id="resComentario" class="editable-input" rows="3"></textarea>

                <div class="auth-check">
                    <input type="checkbox" id="checkFisico">
                    <label for="checkFisico">Confirmo que el cliente present√≥ el documento original.</label>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" style="flex: 2;" onclick="confirmarGuardado()">‚úÖ GUARDAR REGISTRO</button>
                    <button class="btn" style="flex: 1; background: #e74c3c;" onclick="resetEscaneo()">üîÑ</button>
                </div>
            </div>

            <button onclick="exportarExcel()" style="background:#34495e; color:white; border:none; padding:12px; margin-top:40px; border-radius:8px; width:100%;">üìä DESCARGAR EXCEL</button>
            <button onclick="cerrarSesion()" style="background: none; border: none; color: #e74c3c; cursor: pointer; text-decoration: underline; margin-top: 20px;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAE1KBu1CufjKO65OpVHOPcmhyliQYsoDU",
            authDomain: "miescanerweb.firebaseapp.com",
            projectId: "miescanerweb",
            storageBucket: "miescanerweb.firebasestorage.app",
            messagingSenderId: "403272649163",
            appId: "1:403272649163:web:53f29dd4e676c31d268e4e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const URL_GOOGLE = 'https://script.google.com/a/macros/ueno.com.py/s/AKfycbwltAbV25PBEiCkCU5YCOb-4upps3eO6dzPwxH1ANtgT17VCOkrDQfifzpF2myDWXbt/exec';

        const EVENTOS_DEFAULT = ["Oficina del IPS", "Playa San Jose", "Xpo Casa ueno San Bernardino", "Rakiura", "Otros"];
        function cargarEventos() {
            let evs = JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT;
            const sel = document.getElementById('resEvento');
            sel.innerHTML = '<option value="">Seleccionar...</option>';
            evs.forEach(e => sel.innerHTML += `<option value="${e}">${e}</option>`);
        }
        function agregarEvento() {
            let n = prompt("Nuevo evento:");
            if (n) {
                let evs = JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT;
                evs.push(n);
                localStorage.setItem('listaEventosPY', JSON.stringify(evs));
                cargarEventos();
            }
        }
        function eliminarEvento() {
            let v = document.getElementById('resEvento').value;
            if (v && confirm("¬øEliminar?")) {
                let evs = (JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT).filter(e => e !== v);
                localStorage.setItem('listaEventosPY', JSON.stringify(evs));
                cargarEventos();
            }
        }

        const MOTIVOS = [
            "Consultas (especificar en comentario)", "Onboarding sin retiro de tarjeta", "Onboarding con retiro de tarjetas",
            "Solo vinculaci√≥n de tarjeta", "Activaci√≥n de TC y TD", "Firma de CU", "TC Albirroja nueva",
            "Error al vincular la tarjeta", "Inconveniente con registro en la App", "Solicitud de oferta TC denegada",
            "Solicitud oferta Pr√©stamo", "Activaci√≥n cuenta menor", "Reimpresi√≥n de tarjeta", "Reimpresi√≥n TC Albirroja",
            "Alta de ahorro programado", "Reclamos sobre productos", "Solicitud de oferta de TC", "Solicitud aumento linea de TC",
            "Error al ingresar en la app", "Vinculaci√≥n de Alias", "Actualizaci√≥n de F√© de vida", "Cambio entidad bancaria jubilados",
            "Nuevo Jubilado", "Otro"
        ];
        const cont = document.getElementById('contenedorMotivos');
        MOTIVOS.forEach(m => {
            cont.innerHTML += `<label class="checkbox-item"><input type="checkbox" name="motivoItem" value="${m}"> ${m}</label>`;
        });

        function cambiarPantalla(p) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById(p).style.display = 'block';
        }
        function mostrarOcultarClave(i, o) {
            const el = document.getElementById(i);
            el.type = el.type === "password" ? "text" : "password";
            document.getElementById(o).innerText = el.type === "password" ? "üëÅÔ∏è" : "üôà";
        }
        
        auth.onAuthStateChanged(u => {
            if (u) {
                cambiarPantalla('scannerSection');
                document.getElementById('welcomeMsg').innerText = "Bienvenido: " + (u.displayName || u.email);
                encenderCamara(); cargarEventos();
            }
        });
        
        document.getElementById('loginForm').onsubmit = e => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(() => alert("Error al iniciar sesi√≥n"));
        };
        document.getElementById('registerForm').onsubmit = async e => {
            e.preventDefault();
            const p = document.getElementById('regPassword').value;
            if(p !== document.getElementById('regConfirmPassword').value) return alert("Las contrase√±as no coinciden");
            try {
                const res = await auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, p);
                await res.user.updateProfile({ displayName: document.getElementById('regNombre').value + " " + document.getElementById('regApellido').value });
                alert("Cuenta creada exitosamente.");
            } catch(e) { alert(e.message); }
        };
        function cerrarSesion() { auth.signOut(); location.reload(); }

        async function encenderCamara() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
                document.getElementById('video').srcObject = s;
            } catch (e) {
                console.log(e);
            }
        }

        async function capturarCedula() {
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            const ctx = c.getContext('2d', { willReadFrequently: true });
            
            c.width = v.videoWidth; 
            c.height = v.videoHeight;
            ctx.drawImage(v, 0, 0, c.width, c.height);
            
            let imgData = ctx.getImageData(0, 0, c.width, c.height);
            let pixels = imgData.data;
            for (let i = 0; i < pixels.length; i += 4) {
                let gris = (pixels[i] * 0.3) + (pixels[i+1] * 0.59) + (pixels[i+2] * 0.11);
                let color = gris > 110 ? 255 : 0; 
                pixels[i] = color; 
                pixels[i+1] = color; 
                pixels[i+2] = color;
            }
            ctx.putImageData(imgData, 0, 0);
            
            try {
                const res = await Tesseract.recognize(c.toDataURL('image/png'), 'spa');
                const txt = res.data.text.toUpperCase();
                const lineas = txt.split('\n').map(l => l.trim()).filter(l => l.length > 2);

                let cedulaFinal = "";
                const numerosEncontrados = txt.match(/\b\d{6,8}\b/g);
                if (numerosEncontrados && numerosEncontrados.length > 0) {
                    cedulaFinal = numerosEncontrados[0]; 
                }

                let apellidos = "", nombres = "";
                for(let i = 0; i < lineas.length; i++) {
                    let lineaActual = lineas[i];

                    if(/(APELL|PELL|APEL|APELLIDO)/.test(lineaActual)) {
                        let textoLimpiado = lineaActual.replace(/.*(APELLIDOS?|PELLIDOS?|APEL)\s*/, '').replace(/[^A-Z√ë\s]/g, '').trim();
                        if (textoLimpiado.length > 2) { apellidos = textoLimpiado; } 
                        else if (lineas[i+1]) { apellidos = lineas[i+1].replace(/[^A-Z√ë\s]/g, '').trim(); }
                    }

                    if(/(NOMB|NONB|NOMBRE)/.test(lineaActual)) {
                        let textoLimpiado = lineaActual.replace(/.*(NOMBRES?|NONBRES?|NOMBRE)\s*/, '').replace(/[^A-Z√ë\s]/g, '').trim();
                        if (textoLimpiado.length > 2) { nombres = textoLimpiado; } 
                        else if (lineas[i+1]) { nombres = lineas[i+1].replace(/[^A-Z√ë\s]/g, '').trim(); }
                    }
                }

                document.getElementById('resNombre').value = (apellidos + " " + nombres).trim();
                document.getElementById('resCedula').value = cedulaFinal;

            } catch (e) { console.log("Error OCR:", e); }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultados').style.display = 'block';
        }

        function resetEscaneo() {
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('cameraView').style.display = 'block';
        }

        async function confirmarGuardado() {
            const nom = document.getElementById('resNombre').value.trim();
            const ced = document.getElementById('resCedula').value.trim();
            const cel = document.getElementById('resCelular').value.trim();
            const evento = document.getElementById('resEvento').value;
            
            if(!nom || !ced || !document.getElementById('checkFisico').checked) return alert("Faltan datos o confirmaci√≥n de verificaci√≥n f√≠sica.");

            const checksMotivos = document.querySelectorAll('input[name="motivoItem"]:checked');
            const motivosSeleccionados = Array.from(checksMotivos).map(cb => cb.value).join(' | ');
            
            const correoCliente = document.getElementById('resCorreoCliente').value.trim();
            const productoNuevo = document.querySelector('input[name="resProducto"]:checked').value;
            const codigoTarjeta = document.getElementById('resCodigoTarjeta').value.trim();
            const comentario = document.getElementById('resComentario').value.trim();
            const operador = auth.currentUser.displayName || auth.currentUser.email;

            // ESTE ES EL FORMATO QUE ORDENA TU EXCEL MAGN√çFICAMENTE
            const payload = {
                nombre_cedula: nom, 
                numero_cedula: ced, 
                celular_cliente: cel,
                evento: evento,
                correo_cliente: correoCliente || "Sin correo",
                producto_nuevo: productoNuevo,
                motivos: motivosSeleccionados,
                codigo_tarjeta: codigoTarjeta || "N/A",
                comentarios: comentario || "Sin comentarios",
                fecha: new Date().toLocaleString(), 
                operador_sistema: operador
            };

            // Esto es lo que se env√≠a a Google Sheets
            const payloadGoogle = {
                nombre: nom, cedula: ced, celular: cel, evento: evento, correo: correoCliente,
                producto: productoNuevo, motivos: motivosSeleccionados, operador: operador,
                fecha: new Date().toLocaleDateString(), hora: new Date().toLocaleTimeString(),
                codigo_tarjeta: codigoTarjeta, comentarios: comentario
            };

            try {
                await db.collection("escaneos").add(payload);
                fetch(URL_GOOGLE, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payloadGoogle) });
                alert("‚úÖ Registro guardado con √©xito.");
                resetEscaneo();
            } catch(e) { alert("Error al guardar: " + e.message); }
        }

        // üåü AQU√ç EST√Å TU S√öPER FUNCI√ìN DE EXCEL RESTAURADA üåü
        async function exportarExcel() {
            if (!navigator.onLine) {
                return alert("‚ö†Ô∏è Necesitas conexi√≥n a internet para descargar el Excel completo.");
            }
            alert("Generando Excel ordenado... Esto puede tomar unos segundos.");
            const snap = await db.collection("escaneos").get();
            
            const rawData = [];
            let maxMotivos = 0;
            
            snap.forEach(doc => {
                const data = doc.data();
                let arrayMotivos = [];
                if (data.motivos) {
                    arrayMotivos = data.motivos.split(' | ').filter(m => m.trim() !== "");
                }
                if (arrayMotivos.length > maxMotivos) { maxMotivos = arrayMotivos.length; }
                
                data._arrayMotivos = arrayMotivos; 
                rawData.push(data);
            });
            
            const registrosOrdenados = []; 
            
            rawData.forEach(data => {
                let fechaCorta = data.fecha || "Sin fecha", horaCorta = "";
                if(data.fecha && data.fecha.includes(',')) {
                    let partes = data.fecha.split(',');
                    fechaCorta = partes[0].trim(); horaCorta = partes[1].trim();
                } else if (data.fecha && data.fecha.includes(' ')) {
                    let partes = data.fecha.split(' ');
                    fechaCorta = partes[0].trim(); horaCorta = partes[1].trim();
                }

                let filaExcel = {
                    "Fecha": fechaCorta, "Hora": horaCorta,
                    "Evento / Sucursal": data.evento || "---",
                    "Nombre y Apellido": data.nombre_cedula || data.nombre || "---",
                    "Nro. de C√©dula": data.numero_cedula || data.cedula || "---",
                    "Celular Cliente": data.celular_cliente || data.celular || "---",
                    "Correo Cliente": data.correo_cliente || data.correo || "---",
                    "¬øProducto Nuevo?": data.producto_nuevo || data.producto || "---"
                };
                
                for (let i = 0; i < maxMotivos; i++) {
                    filaExcel[`Motivo ${i + 1}`] = data._arrayMotivos[i] || "---";
                }
                
                filaExcel["C√≥d. Tarjeta (Caja)"] = data.codigo_tarjeta || data.codigo || "---";
                filaExcel["Comentarios"] = data.comentarios || data.comentario || "---";
                filaExcel["Operador"] = data.operador_sistema || data.operador || "---";
                
                registrosOrdenados.push(filaExcel);
            });

            const ws = XLSX.utils.json_to_sheet(registrosOrdenados);
            const wb = XLSX.utils.book_new();
            
            let anchosColumnas = [ 
                { wch: 12 }, { wch: 10 }, { wch: 25 }, { wch: 30 }, 
                { wch: 15 }, { wch: 25 }, { wch: 18 } 
            ];
            for (let i = 0; i < maxMotivos; i++) { anchosColumnas.push({ wch: 35 }); }
            anchosColumnas.push({ wch: 20 }, { wch: 45 }, { wch: 25 });
            
            ws['!cols'] = anchosColumnas;
            XLSX.utils.book_append_sheet(wb, ws, "Base de Datos");
            XLSX.writeFile(wb, "Reporte_CRM_Desglosado.xlsx");
        }
    </script>
</body>
</html>

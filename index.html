<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n PY</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #27ae60; --blue: #3498db; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 480px; min-height: 100vh; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        h2 { font-weight: bold; margin-bottom: 30px; font-size: 28px; color: var(--dark); }
        .auth-form { display: flex; flex-direction: column; gap: 15px; }
        .row { display: flex; gap: 10px; }
        .input-group { position: relative; width: 100%; }
        input, select, textarea { padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; box-sizing: border-box; background: #fff; }
        
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 18px; text-transform: uppercase; margin-top: 10px; }
        .btn-reg { background: var(--blue); }
        .link-auth { color: var(--blue); text-decoration: underline; cursor: pointer; display: inline-block; margin-top: 20px; font-size: 15px; }

        #scannerSection { display: none; }
        #cameraView { margin-top: 20px; }
        .scanner-container { background:#000; height:260px; border-radius:15px; overflow:hidden; position: relative; }
        video { width:100%; height:100%; object-fit:cover; }
        
        #resultados { text-align: left; background: #fff; padding: 15px; border-radius: 10px; border: 2px solid var(--blue); margin-top: 20px; display: none; }
        .label-res { font-size: 12px; color: #34495e; font-weight: bold; margin-bottom: 5px; margin-top: 15px; display: block; text-transform: uppercase; }
        .checkbox-group { max-height: 180px; overflow-y: auto; border: 1px solid #bdc3c7; padding: 12px; border-radius: 10px; background: #fcfcfc; }
        .radio-group { display: flex; gap: 20px; padding: 10px 0; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loginBox">
            <h2 style="margin-top: 60px;">Ingreso al Sistema</h2>
            <form class="auth-form" id="loginForm">
                <input type="email" id="email" placeholder="Correo electr√≥nico" required>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Contrase√±a" required>
                    <span class="eye-icon" onclick="toggleView('password')">üëÅÔ∏è</span>
                </div>
                <button type="submit" class="btn">INGRESAR</button>
            </form>
            <a class="link-auth" onclick="showRegister(true)">¬øNo tienes cuenta? Reg√≠strate aqu√≠</a>
        </div>

        <div id="registerBox" style="display: none;">
            <h2 style="margin-top: 60px;">Crear Cuenta</h2>
            <form class="auth-form" id="registerForm">
                <div class="row">
                    <input type="text" id="regNombre" placeholder="Nombre" required>
                    <input type="text" id="regApellido" placeholder="Apellido" required>
                </div>
                <input type="email" id="regEmail" placeholder="Correo electr√≥nico" required>
                <div class="input-group">
                    <input type="password" id="regPass" placeholder="Contrase√±a (m√≠n. 6 letras)" required>
                    <span class="eye-icon" onclick="toggleView('regPass')">üëÅÔ∏è</span>
                </div>
                <div class="input-group">
                    <input type="password" id="regPassConf" placeholder="Confirme su contrase√±a" required>
                    <span class="eye-icon" onclick="toggleView('regPassConf')">üëÅÔ∏è</span>
                </div>
                <button type="submit" class="btn btn-reg">REGISTRARME</button>
            </form>
            <a class="link-auth" style="color: var(--primary);" onclick="showRegister(false)">¬øYa tienes cuenta? Inicia sesi√≥n</a>
        </div>

        <div id="scannerSection">
            <h3 id="welcomeMsg" style="color: var(--dark);"></h3>
            
            <div id="cameraView">
                <div class="scanner-container">
                    <video id="video" autoplay playsinline></video>
                </div>
                <button class="btn" onclick="capturarCedula()">üì∑ CAPTURAR DATOS</button>
            </div>

            <div id="loading" style="display:none; padding:20px; font-weight:bold; color:var(--primary);">‚åõ PROCESANDO C√âDULA...</div>

            <div id="resultados">
                <label class="label-res">NOMBRE Y APELLIDO *:</label>
                <input type="text" id="resNombre">
                
                <label class="label-res">N√öMERO DE C√âDULA *:</label>
                <input type="number" id="resCedula">

                <label class="label-res">N√öMERO DE CELULAR *:</label>
                <input type="tel" id="resCelular" placeholder="0981...">

                <label class="label-res">NOMBRE DEL EVENTO *:</label>
                <select id="resEvento">
                    <option value="IPS">IPS</option>
                    <option value="Playa San Jose">Playa San Jose</option>
                    <option value="Rakiura">Rakiura</option>
                    <option value="Otros">Otros</option>
                </select>

                <label class="label-res">CORREO ELECTR√ìNICO:</label>
                <input type="email" id="resCorreoCliente">

                <label class="label-res">¬øPRODUCTO NUEVO? *</label>
                <div class="radio-group">
                    <label><input type="radio" name="resProducto" value="SI"> SI</label>
                    <label><input type="radio" name="resProducto" value="No" checked> NO</label>
                </div>

                <label class="label-res">MOTIVOS DE ATENCI√ìN:</label>
                <div class="checkbox-group" id="contenedorMotivos">
                    <label style="display:block"><input type="checkbox" name="motivoItem" value="Consultas"> Consultas</label>
                    <label style="display:block"><input type="checkbox" name="motivoItem" value="Activaci√≥n TC/TD"> Activaci√≥n TC/TD</label>
                    <label style="display:block"><input type="checkbox" name="motivoItem" value="Firma CU"> Firma CU</label>
                    <label style="display:block"><input type="checkbox" name="motivoItem" value="Otro"> Otro</label>
                </div>

                <button class="btn" onclick="confirmarGuardado()">‚úÖ GUARDAR REGISTRO</button>
                <button class="btn" style="background:#e74c3c;" onclick="resetEscaneo()">üîÑ DESCARTAR</button>
            </div>
            
            <button onclick="auth.signOut(); location.reload();" style="margin-top:30px; color:red; background:none; border:none; cursor:pointer; text-decoration:underline;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAE1KBu1CufjKO65OpVHOPcmhyliQYsoDU",
            authDomain: "miescanerweb.firebaseapp.com",
            projectId: "miescanerweb",
            storageBucket: "miescanerweb.firebasestorage.app",
            messagingSenderId: "403272649163",
            appId: "1:403272649163:web:53f29dd4e676c31d268e4e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // üü¢ NUEVA URL DE GOOGLE SHEETS CONFIGURADA
        const URL_EXCEL = 'https://script.google.com/a/macros/ueno.com.py/s/AKfycbwltAbV25PBEiCkCU5YCOb-4upps3eO6dzPwxH1ANtgT17VCOkrDQfifzpF2myDWXbt/exec';

        function showRegister(val) {
            document.getElementById('loginBox').style.display = val ? 'none' : 'block';
            document.getElementById('registerBox').style.display = val ? 'block' : 'none';
        }

        function toggleView(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('registerBox').style.display = 'none';
                document.getElementById('scannerSection').style.display = 'block';
                document.getElementById('welcomeMsg').innerText = "Bienvenido: " + (user.displayName || user.email);
                encenderCamara();
            }
        });

        document.getElementById('registerForm').onsubmit = e => {
            e.preventDefault();
            const p1 = document.getElementById('regPass').value;
            const p2 = document.getElementById('regPassConf').value;
            if(p1 !== p2) return alert("Las contrase√±as no coinciden");

            auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, p1)
                .then(res => {
                    res.user.updateProfile({ displayName: document.getElementById('regNombre').value + " " + document.getElementById('regApellido').value });
                    alert("Cuenta creada con √©xito. Ya puedes ingresar.");
                    showRegister(false);
                })
                .catch(err => alert("Error: " + err.message));
        };

        document.getElementById('loginForm').onsubmit = e => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => alert("Datos incorrectos o usuario no encontrado"));
        };

        async function encenderCamara() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('video').srcObject = s;
            } catch (e) { alert("Error al abrir c√°mara: " + e); }
        }

        async function capturarCedula() {
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);
            
            try {
                const res = await Tesseract.recognize(c.toDataURL(), 'spa');
                document.getElementById('resCedula').value = res.data.text.replace(/\D/g, '').substring(0,8);
            } catch (e) { console.log("Error OCR:", e); }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultados').style.display = 'block';
        }

        function resetEscaneo() {
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('cameraView').style.display = 'block';
        }

        async function confirmarGuardado() {
            const nom = document.getElementById('resNombre').value;
            const ced = document.getElementById('resCedula').value;
            if(!nom || !ced) return alert("Nombre y C√©dula son obligatorios");

            const motivos = Array.from(document.querySelectorAll('input[name="motivoItem"]:checked')).map(cb => cb.value).join(' | ');
            
            const payload = {
                evento: document.getElementById('resEvento').value,
                nombre: nom,
                cedula: ced,
                celular: document.getElementById('resCelular').value,
                correo: document.getElementById('resCorreoCliente').value,
                producto: document.querySelector('input[name="resProducto"]:checked').value,
                motivos: motivos,
                operador: auth.currentUser.email
            };

            try {
                // 1. Guardar en Firebase
                await db.collection("escaneos").add({ ...payload, fecha_registro: new Date() });

                // 2. Enviar a Google Sheets
                fetch(URL_EXCEL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });

                alert("‚úÖ Registro guardado y enviado al nuevo Excel.");
                resetEscaneo();
                document.getElementById('resNombre').value = "";
                document.getElementById('resCedula').value = "";
                document.getElementById('resCelular').value = "";
                document.getElementById('resCorreoCliente').value = "";
            } catch (e) { alert("Error al guardar: " + e); }
        }
    </script>
</body>
</html>

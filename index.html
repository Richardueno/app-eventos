<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n PY</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#27ae60">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732220.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 480px; min-height: 100vh; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        .auth-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="tel"], select, textarea { 
            padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; width: 100%; box-sizing: border-box; 
        }
        
        .password-container { position: relative; width: 100%; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; user-select: none; }

        .scanner-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; height: 260px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 0 45px rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
        .guide-rect { width: 85%; height: 150px; border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 0 15px var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-link { background: none; border: none; color: #3498db; cursor: pointer; font-size: 15px; text-decoration: underline; margin-top: 10px; }
        
        #resultados { margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; text-align: left; border: 2px solid #3498db; display: none; }
        .label-res { font-size: 12px; color: #34495e; font-weight: bold; margin-bottom: 5px; margin-top: 15px; display: block; text-transform: uppercase; }
        .editable-input { margin-bottom: 5px; background-color: #fcfcfc; border: 1px solid #bdc3c7; color: var(--dark); }
        .editable-input:focus { border-color: #3498db; outline: none; background-color: white; }

        .checkbox-group { max-height: 180px; overflow-y: auto; border: 1px solid #bdc3c7; padding: 12px; border-radius: 10px; background: #fcfcfc; margin-bottom: 5px; }
        .checkbox-item { display: block; margin-bottom: 10px; font-size: 14px; color: #2c3e50; }
        .checkbox-item input { margin-right: 8px; transform: scale(1.2); }

        .radio-group { display: flex; gap: 20px; padding: 10px 0; font-size: 16px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .radio-group input { transform: scale(1.3); }

        .auth-check { background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 20px; display: flex; align-items: flex-start; gap: 10px; text-align: left; font-size: 13px; color: #856404; }
        .auth-check input { width: 20px; height: 20px; margin-top: 2px; }

        .name-grid { display: flex; gap: 10px; }
        
        #offlineAlert { display: none; background: #e74c3c; color: white; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; font-size: 13px; }
        
        .event-container { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; }
        .event-container select { flex: 1; margin-bottom: 0; }
        .btn-mini { padding: 15px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div class="card">
        
        <div id="offlineAlert">‚ö†Ô∏è Sin conexi√≥n a Internet. Los datos se guardar√°n en el celular y se subir√°n al volver la se√±al.</div>

        <div id="loginSection">
            <h2>Ingreso al Sistema</h2>
            <form class="auth-form" id="loginForm">
                <input type="email" id="email" name="email" placeholder="Correo electr√≥nico" autocomplete="username" required>
                <div class="password-container">
                    <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('password', 'ojoLogin')"><span id="ojoLogin">üëÅÔ∏è</span></span>
                </div>
                <button type="submit" class="btn">INGRESAR</button>
            </form>
            <button class="btn-link" onclick="cambiarPantalla('registerSection')">¬øNo tienes cuenta? Reg√≠strate aqu√≠</button>
        </div>

        <div id="registerSection" style="display: none;">
            <h2>Crear Cuenta</h2>
            <form class="auth-form" id="registerForm">
                <div class="name-grid">
                    <input type="text" id="regNombre" name="given-name" placeholder="Nombre" required>
                    <input type="text" id="regApellido" name="family-name" placeholder="Apellido" required>
                </div>
                <input type="email" id="regEmail" name="email" placeholder="Correo electr√≥nico" autocomplete="username" required>
                <div class="password-container">
                    <input type="password" id="regPassword" name="new-password" placeholder="Contrase√±a (m√≠n. 6 letras)" autocomplete="new-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('regPassword', 'ojoReg1')"><span id="ojoReg1">üëÅÔ∏è</span></span>
                </div>
                <div class="password-container">
                    <input type="password" id="regConfirmPassword" name="new-password-confirm" placeholder="Confirme su contrase√±a" autocomplete="new-password" required>
                    <span class="toggle-password" onclick="mostrarOcultarClave('regConfirmPassword', 'ojoReg2')"><span id="ojoReg2">üëÅÔ∏è</span></span>
                </div>
                <button type="submit" class="btn" style="background: #3498db;">REGISTRARME</button>
            </form>
            <button class="btn-link" style="color: #27ae60;" onclick="cambiarPantalla('loginSection')">¬øYa tienes cuenta? Inicia sesi√≥n</button>
        </div>

        <div id="scannerSection" style="display: none;">
            <div id="cameraView">
                <div class="scanner-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="overlay"><div class="guide-rect"></div></div>
                </div>
                <button class="btn" onclick="capturarCedula()">üì∑ CAPTURAR DATOS DEL CLIENTE</button>
            </div>

            <div id="loading" style="display:none; margin: 20px; font-weight: bold; color: var(--primary);">‚åõ PROCESANDO...</div>

            <div id="resultados">
                <p style="font-size: 13px; color: #e67e22; margin-top:0; text-align:center;"><strong>Complete el Formulario de Atenci√≥n</strong></p>
                
                <label class="label-res">NOMBRE Y APELLIDO *:</label>
                <input type="text" id="resNombre" class="editable-input" style="font-weight: bold;">
                
                <label class="label-res">N√öMERO DE C√âDULA *:</label>
                <input type="number" id="resCedula" class="editable-input" style="font-weight: bold;">

                <label class="label-res">N√öMERO DE CELULAR *:</label>
                <input type="tel" id="resCelular" class="editable-input" placeholder="Ej: 0981 123 456">

                <hr style="border: 0.5px solid #eee; margin: 20px 0;">

                <label class="label-res">NOMBRE DEL EVENTO *:</label>
                <div class="event-container">
                    <select id="resEvento" class="editable-input"></select>
                    <button type="button" class="btn-mini" style="background: #3498db;" onclick="agregarEvento()" title="Agregar nuevo evento">‚ûï</button>
                    <button type="button" class="btn-mini" style="background: #e74c3c;" onclick="eliminarEvento()" title="Eliminar evento seleccionado">üóëÔ∏è</button>
                </div>

                <label class="label-res">CORREO ELECTR√ìNICO (CLIENTE):</label>
                <input type="email" id="resCorreoCliente" class="editable-input" placeholder="ejemplo@correo.com">

                <label class="label-res">¬øACTIV√ì UN PRODUCTO NUEVO? *</label>
                <div class="radio-group">
                    <label><input type="radio" name="resProducto" value="SI"> SI</label>
                    <label><input type="radio" name="resProducto" value="No" checked> No</label>
                </div>

                <label class="label-res">MOTIVO DE ATENCI√ìN * (Seleccione uno o varios):</label>
                <div class="checkbox-group" id="contenedorMotivos"></div>

                <label class="label-res">N√öMERO DE C√ìDIGO DE TARJETA (CAJA):</label>
                <input type="text" id="resCodigoTarjeta" class="editable-input" placeholder="Ingrese el c√≥digo">

                <label class="label-res">COMENTARIO ADICIONAL:</label>
                <textarea id="resComentario" class="editable-input" rows="3" placeholder="Escriba aqu√≠ sus observaciones..."></textarea>

                <div class="auth-check">
                    <input type="checkbox" id="checkFisico">
                    <label for="checkFisico"><strong>Verificaci√≥n:</strong> Confirmo que el cliente present√≥ el documento original.</label>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" style="flex: 2;" onclick="confirmarGuardado()">‚úÖ GUARDAR REGISTRO</button>
                    <button class="btn" style="flex: 1; background: #e74c3c;" onclick="resetEscaneo()">üîÑ DESCARTAR</button>
                </div>
            </div>

            <button onclick="exportarExcel()" style="background:#34495e; color:white; border:none; padding:12px; margin-top:40px; border-radius:8px; width:100%;">üìä DESCARGAR EXCEL COMPLETO</button>
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 20px; font-weight: bold;" id="userEmailDisplay"></p>
            <button onclick="cerrarSesion()" style="background: none; border: none; color: #e74c3c; cursor: pointer; text-decoration: underline; margin-bottom: 20px;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // REGISTRO DEL SERVICE WORKER PARA QUE LA APP SE INSTALE Y FUNCIONE OFFLINE
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('¬°Modo App Offline Activado!', reg))
                .catch(err => console.log('Error al activar Modo App', err));
            });
        }

        // EVENTOS DIN√ÅMICOS
        const EVENTOS_DEFAULT = ["Oficina del IPS", "Playa San Jose", "Xpo Casa ueno San Bernardino", "Rakiura", "Otros"];

        function cargarEventos() {
            let eventosGuardados = JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT;
            const select = document.getElementById('resEvento');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            eventosGuardados.forEach(ev => {
                let opt = document.createElement('option');
                opt.value = ev; opt.innerText = ev;
                select.appendChild(opt);
            });
        }

        function agregarEvento() {
            let nuevoEvento = prompt("Ingrese el nombre del nuevo evento o sucursal:");
            if (nuevoEvento && nuevoEvento.trim() !== "") {
                let eventosGuardados = JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT;
                if(!eventosGuardados.includes(nuevoEvento.trim())) {
                    eventosGuardados.push(nuevoEvento.trim());
                    localStorage.setItem('listaEventosPY', JSON.stringify(eventosGuardados));
                    cargarEventos();
                    document.getElementById('resEvento').value = nuevoEvento.trim();
                } else { alert("Ese evento ya existe."); }
            }
        }

        function eliminarEvento() {
            let select = document.getElementById('resEvento');
            let valorAEliminar = select.value;
            if (!valorAEliminar) return alert("Seleccione un evento de la lista para eliminarlo.");
            if (confirm("¬øEliminar '" + valorAEliminar + "'?")) {
                let eventosGuardados = JSON.parse(localStorage.getItem('listaEventosPY')) || EVENTOS_DEFAULT;
                eventosGuardados = eventosGuardados.filter(ev => ev !== valorAEliminar);
                localStorage.setItem('listaEventosPY', JSON.stringify(eventosGuardados));
                cargarEventos();
            }
        }
        cargarEventos();

        // MOTIVOS DE ATENCI√ìN
        const listaMotivos = [
            "Consultas (especificar en comentario adicional)", "Onboarding sin retiro de tarjeta", "Onboarding con retiro de tarjetas",
            "Solo vinculaci√≥n de tarjeta (Ingresar el numero sobre)", "Activaci√≥n de TC y TD", "Firma de CU", "TC Albirroja nueva",
            "Error al vincular la tarjeta", "Inconveniente con el registro en la App - Contactar", "Solicitud de oferta TC denegada",
            "Solicitud oferta Pr√©stamo - Contactar", "Activaci√≥n cuenta menor", "Reimpresi√≥n de tarjeta", "Reimpresi√≥n TC Albirroja",
            "Alta de ahorro programado", "Reclamos sobre productos - Contactar", "Solicitud de oferta de TC", "Solicitud de aumento de linea de TC",
            "Error al ingresar en la app", "Vinculaci√≥n de Alias", "Actualizaci√≥n de F√© de vida", "Cambio de entidad bancaria de jubilados",
            "Nuevo Jubilado", "Otro"
        ];
        
        const contenedor = document.getElementById('contenedorMotivos');
        listaMotivos.forEach(motivo => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" name="motivoItem" value="${motivo}"> ${motivo}`;
            contenedor.appendChild(label);
        });

        // DETECCI√ìN DE INTERNET
        window.addEventListener('online', () => document.getElementById('offlineAlert').style.display = 'none');
        window.addEventListener('offline', () => document.getElementById('offlineAlert').style.display = 'block');

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAE1KBu1CufjKO65OpVHOPcmhyliQYsoDU",
            authDomain: "miescanerweb.firebaseapp.com",
            projectId: "miescanerweb",
            storageBucket: "miescanerweb.firebasestorage.app",
            messagingSenderId: "403272649163",
            appId: "1:403272649163:web:53f29dd4e676c31d268e4e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        db.enablePersistence().catch(err => console.log("Offline mode err: ", err.code));

        function cambiarPantalla(pantalla) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById(pantalla).style.display = 'block';
        }

        function mostrarOcultarClave(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === "password") { input.type = "text"; icon.innerText = "üôà"; } 
            else { input.type = "password"; icon.innerText = "üëÅÔ∏è"; }
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nom = document.getElementById('regNombre').value.trim();
            const ape = document.getElementById('regApellido').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPassword').value;
            if(pass !== document.getElementById('regConfirmPassword').value) return alert("‚ùå Las contrase√±as no coinciden.");

            try {
                const userCred = await auth.createUserWithEmailAndPassword(email, pass);
                await userCred.user.updateProfile({ displayName: nom + " " + ape });
                alert("‚úÖ ¬°Cuenta creada! Bienvenido(a)");
            } catch (err) { alert("Error: " + err.message); }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } 
            catch (err) { alert("‚ùå Correo o contrase√±a incorrectos."); }
        });

        function cerrarSesion() { auth.signOut(); window.location.reload(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('registerSection').style.display = 'none';
                document.getElementById('scannerSection').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = "üë§ Operador: " + (user.displayName || user.email);
                encenderCamara();
            }
        });

        async function encenderCamara() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
            document.getElementById('video').srcObject = stream;
        }

        async function capturarCedula() {
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            const ctx = c.getContext('2d');
            
            c.width = v.videoWidth; c.height = v.videoHeight;
            ctx.drawImage(v, 0, 0, c.width, c.height);
            
            const res = await Tesseract.recognize(c.toDataURL('image/png'), 'spa');
            const txt = res.data.text.toUpperCase();
            const lineas = txt.split('\n').map(l => l.trim()).filter(l => l.length > 2);

            const textoSinPuntos = txt.replace(/\D+/g, ' ').trim().split(' ');
            let cedulaFinal = "";
            for (let num of textoSinPuntos) {
                if (num.length >= 6 && num.length <= 8) { cedulaFinal = num; break; }
            }

            let apellidos = "", nombres = "";
            for(let i = 0; i < lineas.length; i++) {
                if(/APELL|PELL|APEL/.test(lineas[i]) && lineas[i+1]) apellidos = lineas[i+1].replace(/[^A-Z√ë\s]/g, '').trim();
                if(/NOMB|NONB|NOMBRE/.test(lineas[i]) && lineas[i+1]) nombres = lineas[i+1].replace(/[^A-Z√ë\s]/g, '').trim();
            }

            document.getElementById('resNombre').value = (apellidos + " " + nombres).trim();
            document.getElementById('resCedula').value = cedulaFinal;
            
            document.getElementById('resCelular').value = ""; 
            document.getElementById('resCorreoCliente').value = ""; 
            document.querySelector('input[name="resProducto"][value="No"]').checked = true;
            document.querySelectorAll('input[name="motivoItem"]').forEach(cb => cb.checked = false);
            document.getElementById('resCodigoTarjeta').value = ""; 
            document.getElementById('resComentario').value = ""; 
            document.getElementById('checkFisico').checked = false; 

            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultados').style.display = 'block';
        }

        function resetEscaneo() {
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('cameraView').style.display = 'block';
        }

        async function confirmarGuardado() {
            const nom = document.getElementById('resNombre').value.trim();
            const ced = document.getElementById('resCedula').value.trim();
            const cel = document.getElementById('resCelular').value.trim();
            const evento = document.getElementById('resEvento').value;
            
            const checksMotivos = document.querySelectorAll('input[name="motivoItem"]:checked');
            const motivosSeleccionados = Array.from(checksMotivos).map(cb => cb.value).join(' | ');

            if(nom === "" || ced === "") return alert("‚ö†Ô∏è El Nombre y la C√©dula son obligatorios.");
            if(cel === "") return alert("‚ö†Ô∏è El N√∫mero de Celular es obligatorio.");
            if(evento === "") return alert("‚ö†Ô∏è Debe seleccionar el Nombre del evento.");
            if(checksMotivos.length === 0) return alert("‚ö†Ô∏è Debe marcar al menos un Motivo de atenci√≥n.");
            if(!document.getElementById('checkFisico').checked) return alert("‚ö†Ô∏è Marque la casilla confirmando que revis√≥ el documento.");

            const correoCliente = document.getElementById('resCorreoCliente').value.trim();
            const productoNuevo = document.querySelector('input[name="resProducto"]:checked').value;
            const codigoTarjeta = document.getElementById('resCodigoTarjeta').value.trim();
            const comentario = document.getElementById('resComentario').value.trim();
            const operador = auth.currentUser.displayName || auth.currentUser.email;

            try {
                await db.collection("escaneos").add({
                    nombre_cedula: nom, 
                    numero_cedula: ced, 
                    celular_cliente: cel,
                    evento: evento,
                    correo_cliente: correoCliente || "Sin correo",
                    producto_nuevo: productoNuevo,
                    motivos: motivosSeleccionados,
                    codigo_tarjeta: codigoTarjeta || "N/A",
                    comentarios: comentario || "Sin comentarios",
                    fecha: new Date().toLocaleString(), 
                    operador_sistema: operador
                });
                
                if (!navigator.onLine) { alert("‚úÖ Guardado localmente. (Se subir√° al volver el internet)"); } 
                else { alert("‚úÖ Formulario guardado en la nube."); }
                resetEscaneo();

            } catch(error) { alert("Error al guardar: " + error.message); }
        }

        async function exportarExcel() {
            if (!navigator.onLine) {
                return alert("‚ö†Ô∏è Necesitas conexi√≥n a internet para descargar el Excel completo.");
            }

            alert("Generando Excel... Esto puede tomar unos segundos.");
            const snap = await db.collection("escaneos").get();
            
            const rawData = [];
            let maxMotivos = 0;
            
            snap.forEach(doc => {
                const data = doc.data();
                let arrayMotivos = [];
                if (data.motivos) {
                    arrayMotivos = data.motivos.split(' | ').filter(m => m.trim() !== "");
                }
                if (arrayMotivos.length > maxMotivos) { maxMotivos = arrayMotivos.length; }
                
                data._arrayMotivos = arrayMotivos; 
                rawData.push(data);
            });
            
            const registrosOrdenados = []; 
            
            rawData.forEach(data => {
                let fechaCorta = data.fecha || "Sin fecha", horaCorta = "";
                if(data.fecha && data.fecha.includes(',')) {
                    let partes = data.fecha.split(',');
                    fechaCorta = partes[0].trim(); horaCorta = partes[1].trim();
                } else if (data.fecha && data.fecha.includes(' ')) {
                    let partes = data.fecha.split(' ');
                    fechaCorta = partes[0].trim(); horaCorta = partes[1].trim();
                }

                let filaExcel = {
                    "Fecha": fechaCorta, "Hora": horaCorta,
                    "Evento / Sucursal": data.evento || "---",
                    "Nombre y Apellido": data.nombre_cedula || data.nombre || "---",
                    "Nro. de C√©dula": data.numero_cedula || data.cedula || "---",
                    "Celular Cliente": data.celular_cliente || "---",
                    "Correo Cliente": data.correo_cliente || "---",
                    "¬øProducto Nuevo?": data.producto_nuevo || "---"
                };
                
                for (let i = 0; i < maxMotivos; i++) {
                    filaExcel[`Motivo ${i + 1}`] = data._arrayMotivos[i] || "---";
                }
                
                filaExcel["C√≥d. Tarjeta (Caja)"] = data.codigo_tarjeta || "---";
                filaExcel["Comentarios"] = data.comentarios || "---";
                filaExcel["Operador"] = data.operador_sistema || data.usuario || "---";
                
                registrosOrdenados.push(filaExcel);
            });

            const ws = XLSX.utils.json_to_sheet(registrosOrdenados);
            const wb = XLSX.utils.book_new();
            
            let anchosColumnas = [ 
                { wch: 12 }, { wch: 10 }, { wch: 25 }, { wch: 30 }, 
                { wch: 15 }, { wch: 15 }, { wch: 25 }, { wch: 18 } 
            ];
            for (let i = 0; i < maxMotivos; i++) { anchosColumnas.push({ wch: 35 }); }
            anchosColumnas.push({ wch: 20 }, { wch: 45 }, { wch: 25 });
            
            ws['!cols'] = anchosColumnas;
            XLSX.utils.book_append_sheet(wb, ws, "Base de Datos");
            XLSX.writeFile(wb, "Reporte_CRM_Desglosado.xlsx");
        }
    </script>
</body>
</html>
